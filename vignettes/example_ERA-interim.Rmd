---
title: "ERA interim example"
author: "JM Delgado"
date: "`r Sys.Date()`"
output: rmarkdown::github_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Requirements for using the ECMWF API

1. In order to access the ECMWF API you need to [register your own username](https://apps.ecmwf.int/registration/), [agree to licence agreement](https://apps.ecmwf.int/datasets/licences/general/) and [obtain key](https://api.ecmwf.int/v1/key/) from ECMWF before proceeding.

2. You should install conda, create an environment for the ECMWF API client and install `ecmwf-api-client` from a channel e.g. __conda-forge__.

__It is important to start the python instance with `reticulate` before loading any other package!!__

## Add parameter to `vartable`

Check [the parameter database of ECMWF](https://apps.ecmwf.int/codes/grib/param-db) and update the existing table with the necessary parameter. Then please be so kind and do a pull request on [my repo](https://github.com/jmigueldelgado/scraping)

```{r, results='asis'}
library(scraping)
library(dplyr)

vartext='U component of wind'
varcode='131'
if((vartable %>% filter(variable== vartext) %>% nrow)==0)
  {
    vartable = vartable %>%
      bind_rows(.,data_frame(variable=vartext,varname=varcode,dataset="reanalysis-era5-complete"))
    save(vartable,file='data/vartable.rda')
  }

```

## Define request, download and convert from ncdf to data frame and save
`var` should be a meteorological variable name as a string. Variables are available from two datasets. From NCEP such as: `temperature`,`relative humidity`,`u wind`,`v wind`,`soil heat flux`,`net radiation` or `precipitation rate`. And from [GPCC](http://dx.doi.org/10.5676/DWD_GPCC/FD_D_V2018_100) such as `gpcc precipitation` and `number of gauges`.

### Define request
```{r, results='asis'}
# library(scraping)
library(dplyr)
l=13.40
r=13.80
b=52.20
t=52.80

geom=list(cbind(c(l,r,r,l,l),c(b,b,t,t,b))) %>%
        sf::st_polygon(.) %>%
        sf::st_sfc(.) %>%
        sf::st_sf(.) %>%
        sf::st_set_crs(.,4326)

var= '2 metre temperature'
years <- c('2000')
setwd('/home/delgado/proj/scraping')
library(scraping)

vartable

request <- scraping::def_request(var,geom,years,'reanalysis-era5-complete',level,levtype)
request_i <- dplyr::distinct(request,varname,year,.keep_all=TRUE)
request_i$fname='mydownload'
request_i$prefix='mydownload'



  bb=sf::st_buffer(geom,0.125) %>%
    sf::st_bbox()
  request=request_i


  # query = r_to_py(list(
  #   class='ea',
  #   expver='1',
  #   stream='oper',
  #   type='an',
  #   levtype='sfc',
  #   param=request$varname,
  #   date=paste0(request$year,'-01-01/to/',request$year,'-12-31'),
  #   time='00/12',
  #   step='0',
  #   # grid=paste0(gridsize,'/',gridsize),
  #   area=paste0(bb[4],'/',bb[1],'/',bb[2],'/',bb[3]), # N/W/S/E
  #   format='netcdf'
  #   ))
  library(reticulate)

  conda_location = readline("Please enter the absolute location of your conda installation (for default press return):")
  if(conda_location=='') conda_location = '~/local/miniconda3'

  conda_env = readline("Please enter the name of the conda environment containing the ecmwfapi python package  (for default press return):")
  if(conda_env=='') conda_env = 'ecmwf'

  Sys.setenv(RETICULATE_PYTHON=paste0(conda_location,'/envs/',conda_env,'/bin/python'))
  py_config()
  cds <- import('cdsapi')
  client=cds$Client()

### model level

  query = r_to_py(list(
    class='ea',
    expver='1',
    stream='oper',
    type='an',
    levtype='ml',
    param='130',
    levelist= '1/10/50/100',
    date='2013-01-01',
    time='00/to/23/by/6'
    ))

### pressure level

    query = r_to_py(list(
      class='ea',
      expver='1',
      stream='oper',
      type='an',
      levtype='pl',
      param='130',
      levelist= '100/800',
      date='2013-01-01',
      time='00/to/23/by/6'
      ))


### surface

      query = r_to_py(list(
        class='ea',
        expver='1',
        stream='oper',
        type='an',
        levtype='sfc',
        param='167', # 2m temperature
        date='2013-01-01',
        time='00/to/23/by/6'
        ))


  client$retrieve('reanalysis-era5-complete',query,target='temp_test.grib')


# get_nc(request_i)
  ```
