---
title: "NCEP example"
author: "JM Delgado"
date: "`r Sys.Date()`"
output: rmarkdown::github_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Define request, download and convert from ncdf to data frame and save
`var` should be a meteorological variable name as a string such as `temperature`,`relative humidity`,`u wind`,`v wind`,`soil heat flux`,`net radiation` or `precipitation rate`.

### Define request
```{r, results='asis'}
library(scraping)
```

Insert coordinates as points:
```{r, results='asis'}
coor <- data.frame(lon=c(13.40,13.91),lat=c(52.52,52.90))
```
...or as left, right, bottom and top extents of your region of interest:
```{r, results='asis'}
coor <- data.frame(l=12,r=14,b=50,t=53)
```

Choose years and variables
```{r, results='asis'}
var <- c('net radiation')
years <- c('2000','2001')
setwd('/home/delgado/proj/scraping')
request <- def_request(coor,var,years)
knitr::kable(request)


v=request$varname
i=1
fname <- paste0(request$fname[i],'.',request$year[i],'.nc')
library(reshape2)
library(ncdf4)
nc=nc_open(fname)
tt=ncvar_get(nc,varid="time")
tformat= ymd_hms("1800-01-01 00:00:00")+hours(tt)
lat=ncvar_get(nc,varid="lat")
lon=ncvar_get(nc,varid="lon")
nlatlon <- def_spatial_domain(nc,request[i,])
var=lookup_ncep(v) %>% pull(variable)
x <- ncvar_get(nc,v,start=c(min(nlatlon[[1]]),min(nlatlon[[2]]),1),count=c(length(nlatlon[[1]]),length(nlatlon[[2]]),length(tformat)))

dimnames(x)[[1]] <- lon[nlatlon[[1]]]
dimnames(x)[[2]] <- lat[nlatlon[[2]]]
dimnames(x)[[3]]  <- as.numeric(tformat)

xmelt <- melt(x)
colnames(xmelt) <- c("lon","lat","time","value")

DF[[i]] <- xmelt %>% mutate(time=as_datetime(time),var=var)
nc_close(nc)

```

### Download and convert from ncdf to data frame and save
```{r eval=FALSE}

get_nc(request)

nc2rds(request)

```


## Load rds data examples

### Load air temperature

```{r, results='asis'}
library(scraping)
library(dplyr)
library(lubridate)

var=lookup_var('net radiation') %>% pull(varname)

myproj='/home/delgado/proj/scraping/'

df1=readRDS(paste0(myproj,var,'.rds'))

head(df1) %>% knitr::kable()

df1 %>%
    group_by(day=floor_date(time,"day")) %>%
    summarise(daily_max=max(value),daily_min=min(value),daily_mean=mean(value),var=first(var)) %>%  
    head() %>%
    knitr::kable()
```
