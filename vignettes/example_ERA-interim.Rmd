---
title: "ERA interim example"
author: "JM Delgado"
date: "`r Sys.Date()`"
output: rmarkdown::github_document
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
## Requirements for using the ECMWF API

1. In order to access the ECMWF API you need to [register your own username](https://apps.ecmwf.int/registration/), [agree to licence agreement](https://apps.ecmwf.int/datasets/licences/general/) and [obtain key](https://api.ecmwf.int/v1/key/) from ECMWF before proceeding.

2. You should install conda, create an environment for the ECMWF API client and install `ecmwf-api-client` from a channel e.g. __conda-forge__.

__It is important to start the python instance with `reticulate` before loading any other package!!__

## Define request, download and convert from ncdf to data frame and save
`var` should be a meteorological variable name as a string. Variables are available from two datasets. From NCEP such as: `temperature`,`relative humidity`,`u wind`,`v wind`,`soil heat flux`,`net radiation` or `precipitation rate`. And from [GPCC](http://dx.doi.org/10.5676/DWD_GPCC/FD_D_V2018_100) such as `gpcc precipitation` and `number of gauges`.

### Define request
```{r, results='asis'}
library(reticulate)
library(dplyr)

coor <- data.frame(lon=c(13.40,13.91),lat=c(52.52,52.90))
var= '2 metre temperature'
years <- c('2000')
setwd('/home/delgado/proj/scraping')
```

### Define conda environment containing the cdsapi

```{r, results='asis'}

conda_location = '~/local/miniconda3'
conda_env = 'ecmwf'
Sys.setenv(RETICULATE_PYTHON=paste0(conda_location,'/envs/',conda_env,'/bin/python'))
py_config()
cds <- import('cdsapi')
client=cds$Client()

request <- scraping::def_request(coor,var,'era5',years)
# knitr::kable(request)
gridsize=2.5
bb = sf::st_buffer(request,gridsize) %>%
  sf::st_bbox()

query = list(
  class='ea',
  expver='1',
  stream='oper',
  type='an',
  param=request$varname[1], # air temperature (2m), check parameter db in https://apps.ecmwf.int/codes/grib/param-db
  levtype='sfc',
  date=paste0(request$year[1],'-01-01'),
  time='00/12',
  grid=paste0(gridsize,'/',gridsize),
  area=paste0(bb[4],'/',bb[1],'/',bb[2],'/',bb[3])
  )

#
# query=list(class= 'ea',
#     expver= '1',
#     stream= 'moda',
#     type= 'an',
#     param= '167.128',
#     levtype='sfc',
#     date= '2018-01-01',
#     decade= '2010')


client$retrieve('reanalysis-era5-complete',query,target='./mydownload_test2.grib')



```
